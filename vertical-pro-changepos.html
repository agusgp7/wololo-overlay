<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vertical Pro ChangePos</title>

  <style>
    html,body{
      margin:0;
      background:transparent;
      font-family:Arial,Helvetica,sans-serif;
    }

    /* ===== PANEL ===== */
    .wrap{
      width:560px;
      padding:12px 14px;
      background:rgba(0,0,0,.72);
      border-radius:16px;
      color:#fff;

      opacity:0;
      transform:translateY(10px);
      transition:opacity .35s ease, transform .35s ease;
      pointer-events:none;

      box-shadow:0 14px 44px rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.12);
    }
    .wrap.show{
      opacity:1;
      transform:translateY(0);
    }

    .head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .title{
      font-size:18px;
      font-weight:1000;
      letter-spacing:.5px;
      opacity:.95;
    }
    .pill{
      font-size:12px;
      font-weight:900;
      letter-spacing:.9px;
      text-transform:uppercase;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 8px;
    }

    td{
      font-size:20px;
      padding:10px 10px;
      vertical-align:middle;
      white-space:nowrap;
    }

    tr.card td{
      background:rgba(255,255,255,.06);
    }
    tr.card td:first-child{
      border-top-left-radius:14px;
      border-bottom-left-radius:14px;
    }
    tr.card td:last-child{
      border-top-right-radius:14px;
      border-bottom-right-radius:14px;
    }

    .rank{width:72px;font-weight:1000;}
    .elo{width:92px;font-weight:900;text-align:right;padding-right:12px;}
    .player{min-width:0;}

    .name{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:1000;
      min-width:0;
    }

    .arrow{
      width:22px;
      text-align:center;
      font-size:18px;
      font-weight:1000;
    }
    .up{color:#3dff7a;}
    .down{color:#ff4b4b;}

    .flag{
      width:26px;
      height:18px;
      border-radius:3px;
    }
    .cc{
      font-size:13px;
      font-weight:1000;
      opacity:.85;
      width:28px;
      text-align:center;
    }
    .nm{
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .from{
      font-size:13px;
      font-weight:900;
      opacity:.75;
      margin-left:6px;
    }

    tr.moved-up td{
      background:rgba(61,255,122,.14);
      border-top:1px solid rgba(61,255,122,.22);
      border-bottom:1px solid rgba(61,255,122,.22);
    }
    tr.moved-up td:first-child{
      box-shadow:inset 4px 0 0 rgba(61,255,122,.75);
    }

    tr.moved-down td{
      background:rgba(255,75,75,.14);
      border-top:1px solid rgba(255,75,75,.22);
      border-bottom:1px solid rgba(255,75,75,.22);
    }
    tr.moved-down td:first-child{
      box-shadow:inset 4px 0 0 rgba(255,75,75,.75);
    }

    .foot{
      margin-top:8px;
      font-size:12px;
      opacity:.7;
      display:flex;
      justify-content:space-between;
    }
  </style>
</head>

<body>
<div class="wrap" id="wrap">
  <div class="head">
    <div class="title">Position changes</div>
    <div class="pill" id="pill">LIVE</div>
  </div>

  <table>
    <tbody id="rows"></tbody>
  </table>

  <div class="foot">
    <span id="ts">—</span>
    <span>Appears only on rank changes</span>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API = "https://wololo-backend.onrender.com/ranking";
const REFRESH_MS = 10000;
const SHOW_MS = 14000;
const MAX_ITEMS = 3;

/* TEST MODE */
const TEST_MODE = new URLSearchParams(window.location.search).get("test") === "1";

/* ================= UTILS ================= */
function esc(s){
  return String(s??"").replace(/[&<>"']/g,m=>(
    {"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]
  ));
}

function ccToTwemojiFile(cc){
  if(!cc || cc.length!==2) return "";
  const A="A".charCodeAt(0);
  const up=cc.toUpperCase();
  return (
    (0x1F1E6 + up.charCodeAt(0)-A).toString(16) + "-" +
    (0x1F1E6 + up.charCodeAt(1)-A).toString(16)
  );
}

function flagImgHtml(cc){
  const f=ccToTwemojiFile(cc);
  if(!f) return "";
  return `<img class="flag" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/${f}.svg">`;
}

/* ================= STATE ================= */
let prevRank = new Map();
let hideTimer=null;
let everLoaded=false;

/* ================= TEST DATA ================= */
function mockMovers(){
  return [
    {name:"Hera",country:"ca",cc:"CA",elo:"1589",newRank:1,oldRank:3,delta:+2},
    {name:"Hearttt",country:"pe",cc:"PE",elo:"1519",newRank:2,oldRank:1,delta:-1},
    {name:"ACCM",country:"vn",cc:"VN",elo:"1490",newRank:3,oldRank:5,delta:+2}
  ];
}

/* ================= UI ================= */
function showPanel(){
  const w=document.getElementById("wrap");
  w.classList.add("show");
  clearTimeout(hideTimer);
  hideTimer=setTimeout(()=>w.classList.remove("show"),SHOW_MS);
}

function render(movers){
  const tb=document.getElementById("rows");
  tb.innerHTML="";
  movers.slice(0,MAX_ITEMS).forEach(m=>{
    const up=m.delta>0;
    const tr=document.createElement("tr");
    tr.className=`card ${up?"moved-up":"moved-down"}`;
    tr.innerHTML=`
      <td class="rank">#${m.newRank}</td>
      <td class="elo">${m.elo}</td>
      <td class="player">
        <div class="name">
          <span class="arrow ${up?"up":"down"}">${up?"▲":"▼"}</span>
          ${flagImgHtml(m.country)}
          <span class="cc">${m.cc}</span>
          <span class="nm">${esc(m.name)}</span>
          <span class="from">from #${m.oldRank}</span>
        </div>
      </td>`;
    tb.appendChild(tr);
  });
  document.getElementById("pill").textContent=`${movers.length} change${movers.length>1?"s":""}`;
  document.getElementById("ts").textContent=new Date().toLocaleTimeString();
}

/* ================= LOGIC ================= */
function computeMovers(data){
  const movers=[];
  data.forEach(p=>{
    const old=prevRank.get(p.name);
    const now=Number(p.rank);
    if(old && old!==now){
      movers.push({
        name:p.name,
        country:p.country,
        cc:(p.country||"").toUpperCase(),
        elo:p.elo,
        newRank:now,
        oldRank:old,
        delta:old-now
      });
    }
  });
  prevRank=new Map(data.map(x=>[x.name,Number(x.rank)]));
  movers.sort((a,b)=>Math.abs(b.delta)-Math.abs(a.delta));
  return movers;
}

async function tick(){
  try{
    if(TEST_MODE){
      render(mockMovers());
      showPanel();
      return;
    }

    const r=await fetch(API,{cache:"no-store"});
    if(!r.ok) return;
    const data=await r.json();
    if(!Array.isArray(data)||!data.length) return;

    const movers=computeMovers(data);
    if(!everLoaded){ everLoaded=true; return; }
    if(movers.length){
      render(movers);
      showPanel();
    }
  }catch{}
}

tick();
setInterval(tick,REFRESH_MS);
</script>
</body>
</html>
