<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vertical Pro ChangePos</title>

  <style>
    html,body{
      margin:0;
      background:transparent;
      font-family:Arial,Helvetica,sans-serif;
    }

    /* ===== PANEL TRANSPARENTE ===== */
    .wrap{
      width:560px;
      padding:8px 10px;
      background:transparent;
      color:#fff;

      opacity:0;
      transform:translateY(10px) scale(.99);
      filter:blur(1.5px);
      transition:opacity .25s ease, transform .25s ease, filter .25s ease;
      pointer-events:none;
    }
    .wrap.show{
      opacity:1;
      transform:translateY(0) scale(1);
      filter:blur(0);
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 10px;
    }

    /* Cada fila es una card */
    tr.card{
      position:relative;
    }
    td{
      font-size:20px;
      padding:11px 12px;
      vertical-align:middle;
      white-space:nowrap;
      background:transparent;
    }

    /* Card base (borde suave) */
    tr.card td{
      border:1px solid rgba(255,255,255,.10);
      border-left:none;
      border-right:none;
    }
    tr.card td:first-child{
      border-left:1px solid rgba(255,255,255,.10);
      border-top-left-radius:14px;
      border-bottom-left-radius:14px;
    }
    tr.card td:last-child{
      border-right:1px solid rgba(255,255,255,.10);
      border-top-right-radius:14px;
      border-bottom-right-radius:14px;
    }

    /* ===== FILA: ANIMACIÓN STAGGER (izq->der) =====
       Cada TR tiene un div .fill detrás que animamos: opacity 0 -> 0.85 (85%)
       Y el contenido se desliza desde la izquierda + aparece.
    */
    tr.card{ overflow:hidden; }
    tr.card .fill{
      position:absolute;
      inset:0;
      border-radius:14px;
      opacity:0;                 /* start invisible */
      transform:translateX(-14px); /* start left */
      transition:
        opacity .35s ease,
        transform .35s cubic-bezier(.2,.9,.2,1);
      z-index:0;
      pointer-events:none;
    }

    tr.card .content{
      position:relative;
      z-index:1;
      opacity:0;                 /* start invisible */
      transform:translateX(-18px);
      transition:
        opacity .35s ease,
        transform .35s cubic-bezier(.2,.9,.2,1);
    }

    /* Estado visible (lo activamos por JS con clase .in) */
    tr.card.in .fill{
      opacity:.85;              /* ✅ 85% */
      transform:translateX(0);
    }
    tr.card.in .content{
      opacity:1;
      transform:translateX(0);
    }

    /* Colores del fill */
    tr.moved-up .fill{
      background:rgba(61,255,122,.85);
      /* pero como es muy fuerte, lo suavizamos usando mezcla */
      background:rgba(61,255,122,.50);
      /* y dejamos la opacidad final en .85 del propio elemento */
    }
    tr.moved-down .fill{
      background:rgba(255,75,75,.50);
    }

    /* Barra lateral del movimiento */
    tr.moved-up td:first-child{ box-shadow:inset 4px 0 0 rgba(61,255,122,.95); }
    tr.moved-down td:first-child{ box-shadow:inset 4px 0 0 rgba(255,75,75,.95); }

    /* ===== COLUMNAS ===== */
    .rank{width:76px;font-weight:1000;}
    .elo{width:92px;font-weight:900;text-align:right;padding-right:12px;}
    .player{min-width:0;}

    .name{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:1000;
      min-width:0;
    }

    .arrow{
      width:22px;
      text-align:center;
      font-size:18px;
      font-weight:1000;
      flex:0 0 auto;
    }
    .up{color:#3dff7a;}
    .down{color:#ff4b4b;}

    .flag{
      width:26px;
      height:18px;
      border-radius:3px;
      flex:0 0 auto;
    }
    .nm{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
    }
  </style>
</head>

<body>
  <div class="wrap" id="wrap">
    <table>
      <tbody id="rows"></tbody>
    </table>
  </div>

<script>
/* ================= CONFIG ================= */
const API = "https://wololo-backend.onrender.com/ranking";
const REFRESH_MS = 10000;
const SHOW_MS = 5000;      // ✅ solo 5 segundos visible
const MAX_ITEMS = 3;
const STAGGER_MS = 200;    // ✅ 200 ms

/* TEST MODE */
const TEST_MODE = new URLSearchParams(window.location.search).get("test") === "1";

/* ================= UTILS ================= */
function esc(s){
  return String(s??"").replace(/[&<>"']/g,m=>(
    {"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]
  ));
}
function ccToTwemojiFile(cc){
  if(!cc || String(cc).length!==2) return "";
  const A="A".charCodeAt(0);
  const up=String(cc).toUpperCase();
  return (
    (0x1F1E6 + up.charCodeAt(0)-A).toString(16) + "-" +
    (0x1F1E6 + up.charCodeAt(1)-A).toString(16)
  );
}
function flagImgHtml(cc){
  const f=ccToTwemojiFile(cc);
  if(!f) return "";
  return `<img class="flag" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/${f}.svg" alt="">`;
}

/* ================= STATE ================= */
let prevRank = new Map();  // name -> rank
let hideTimer = null;
let everLoaded = false;

/* ================= TEST DATA ================= */
function mockMovers(){
  return [
    {name:"Hera",country:"ca",elo:"1589",newRank:1,delta:+2},
    {name:"Hearttt",country:"pe",elo:"1519",newRank:2,delta:-1},
    {name:"ACCM",country:"vn",elo:"1490",newRank:3,delta:+2}
  ];
}

/* ================= UI ================= */
function showPanel(){
  const w = document.getElementById("wrap");
  w.classList.add("show");
  clearTimeout(hideTimer);
  hideTimer = setTimeout(() => w.classList.remove("show"), SHOW_MS);
}

function render(movers){
  const tb = document.getElementById("rows");
  tb.innerHTML = "";

  const top = movers.slice(0, MAX_ITEMS);

  top.forEach((m, idx) => {
    const up = m.delta > 0;
    const tr = document.createElement("tr");
    tr.className = `card ${up ? "moved-up" : "moved-down"}`;

    tr.innerHTML = `
      <td colspan="3" style="padding:0;border:none;background:transparent">
        <div class="fill"></div>
        <div class="content">
          <table style="width:100%;border-collapse:collapse">
            <tr>
              <td class="rank">#${esc(m.newRank)}</td>
              <td class="elo">${esc(m.elo)}</td>
              <td class="player">
                <div class="name">
                  <span class="arrow ${up ? "up" : "down"}">${up ? "▲" : "▼"}</span>
                  ${flagImgHtml(m.country)}
                  <span class="nm">${esc(m.name)}</span>
                </div>
              </td>
            </tr>
          </table>
        </div>
      </td>
    `;

    tb.appendChild(tr);

    // Stagger: activa la animación de cada fila una tras otra
    setTimeout(() => tr.classList.add("in"), idx * STAGGER_MS);
  });
}

function computeMovers(data){
  const movers = [];
  for(const p of data){
    const old = prevRank.get(p.name);
    const now = Number(p.rank);
    if(old && old !== now){
      movers.push({
        name: p.name,
        country: (p.country || "").toLowerCase(),
        elo: p.elo,
        newRank: now,
        delta: old - now // >0 sube, <0 baja
      });
    }
  }
  prevRank = new Map(data.map(x => [x.name, Number(x.rank)]));

  // ordenar por impacto (saltos grandes primero)
  movers.sort((a,b)=>Math.abs(b.delta)-Math.abs(a.delta));
  return movers;
}

async function tick(){
  try{
    if(TEST_MODE){
      render(mockMovers());
      showPanel();
      return;
    }

    const r = await fetch(API, { cache:"no-store" });
    if(!r.ok) return;
    const data = await r.json();
    if(!Array.isArray(data) || !data.length) return;

    const movers = computeMovers(data);

    // primera lectura solo inicializa, no muestra
    if(!everLoaded){
      everLoaded = true;
      return;
    }

    if(movers.length){
      render(movers);
      showPanel();
    }
  }catch{}
}

tick();
setInterval(tick, REFRESH_MS);
</script>
</body>
</html>
